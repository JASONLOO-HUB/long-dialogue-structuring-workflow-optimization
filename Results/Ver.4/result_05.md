好的，作为技术文档架构师，我将依据提供的JSON大纲和对话记录，生成一份精确、结构化的技术文档。

**核心原则：** 只记录最终决策，忽略讨论过程、被否决的方案和闲聊。将口语转化为专业术语，并使用清晰的层级结构。

---

# 动态窗口与知识地图技术文档

本文档定义了AI学习工具中“动态窗口”与“知识地图”两大核心模块的UI/UX设计、交互逻辑及技术规范。

## 1. 知识地图设计：缩略图与全景界面

知识地图系统包含两个主要组件：一个常驻于顶部的“缩略图”（Minimap），用于实时导航；一个可全屏展开的“全景地图”（Full Atlas），用于全局复盘与跳转。整个设计遵循“地铁线路图”的视觉隐喻，强调逻辑的清晰性与秩序感。

### 1.1 地铁线路图式知识地图UI/UX设计

#### **1.1.1 缩略图设计 (The Top Minimap)**

缩略图是一个位于屏幕顶部的、固定的、高60px-80px的水平长条。它作为轻量化的“逻辑航道仪”，实时反映用户当前的认知路径。

*   **视觉语言**
    *   **基本形态**：采用极简线条风格。主干（L1）为粗灰线，分支（Ln）为细蓝线。
    *   **节点**：节点为圆形。已访问的节点为实心圆，未访问或AI预生成的建议节点为空心圆。

*   **信息层级与显示规范**
    *   **滑动窗口机制 (Sliding Window)**：缩略图仅显示有限的上下文节点。当用户深入探索至新的层级（如L5）时，地图会自动向左平移，始终保持当前节点及其父级、祖父级节点在视野内，旧的根节点则会滑出视野。
    *   **节点数量限制**：
        *   **横向深度 (Dive-in)**：在任何时刻，最多只呈现3个深度层级的节点（如：父节点、当前节点、子节点）。
        *   **纵向关系 (Parallel)**：仅在当前激活的节点上，垂直延伸出最多2个平级关系节点。
    *   **交互反馈**：默认状态下，为保持简洁，仅当前激活节点显示其平级分支。当光标悬停在其他非激活节点上时，可瞬时展示其分支结构。

#### **1.1.2 全景地图界面 (The Full Atlas)**

当用户点击缩略图或使用快捷键时，系统会唤起一个覆盖工作区之上的全屏模态层，即全景地图。

*   **功能定位**：复盘、归纳、跨节点跳转。
*   **设计细节**
    *   **全局纵览**：不受“3横2纵”的节点数量限制，完整展示整个知识树的拓扑结构。
    *   **语义聚合**：系统可自动将同一层级的平级问题归纳为一个“知识簇”，以优化视觉整洁度。

#### **1.1.3 压力测试与解决方案**

*   **问题**：主窗口切换时可能导致缩略图刷新突兀，产生视觉跳跃感。
*   **解决方案**：缩略图的节点切换必须采用平滑位移动画（Tweening），动画时长建议为300ms，以确保视觉的连续性。

#### **1.1.4 技术落地建议**

*   **前端渲染**：缩略图推荐使用 Canvas API 进行渲染，以获得在频繁位移和状态更新场景下的最佳性能。
*   **状态管理**：使用全局状态管理器（如 Redux, Zustand）管理 `active_node_id`，当主画布切换时，同步触发顶部地图的平移与分支重绘。

### 1.2 动态窗口布局：2-Window模式

为解决信息过载问题，主工作区在任何时候最多只显示两个对话窗口，形成“2-Window”动态布局。

#### **1.2.1 2-Window模式下的动态布局与交互**

该模式由一个主窗口（Primary Window）和一个上下文窗口（Context Window）组成，遵循“父左子右”的空间原则。

*   **顶部缩略图：2-Window模式下的“滑动取景器”**
    *   在2-Window模式下，顶部缩略图增加一个**“视口高亮框” (Viewport Bracket)**。
    *   这个高亮框会明确框选出代表当前屏幕上两个可见窗口的对应节点，作为用户的“空间指针”。
    *   当窗口切换时，高亮框会平滑移动到新的节点位置。

*   **主画布2-Window动态推拉逻辑**
    *   **空间分配**：默认采用 **7:3** 的黄金比例。
        *   **Primary Window (右侧, 70%)**: 当前活跃的对话窗口。
        *   **Context Window (左侧, 30%)**: Primary窗口的父级节点，作为逻辑参考。
    *   **“呼吸式”焦点切换逻辑**
        *   **回溯 (Backtrack)**：当用户从右侧主窗口点击“返回上一级”时，不发生物理位移。两窗之间的分割线平滑右移，使布局**反转为7:3（左70%，右30%）**。左侧窗口夺回主场（Primary），右侧窗口变为上下文（Context）。
        *   **再次钻研 (Re-Dive)**：当用户希望重新深入右侧窗口时，分割线平滑左移，恢复为**3:7（左30%，右70%）**的布局。
    *   **“挤压平移”新层级加载逻辑**
        *   仅当用户开启一个**当前屏幕上不存在**的新层级时，触发此动画。
        *   **动画流程**：
            1.  旧的Context窗口（左30%）向左滑出消失。
            2.  旧的Primary窗口（右70%）向左平移并同步**挤压**至30%，成为新的Context窗口。
            3.  全新的卡片从屏幕右侧滑入，占据70%的版面，成为新的Primary窗口。
        *   整个动画过程同步进行，时长控制在350ms，采用 `cubic-bezier(0.4, 0, 0.2, 1)` 缓动曲线以模拟物理推动感。

*   **全景地图界面：从“地铁图”到“作战指挥部”**
    *   **路径溯源**：在全景地图中，用户当前所在的“两窗路径”会以高饱和度颜色（如金黄色）高亮显示，所有其他无关分支则以低饱和度的冷灰色半透明显示，以帮助用户快速定位。
    *   **定位回流**：在全景图中双击任意节点，全景界面会立即收起，主画布将瞬间刷新为该节点（Primary）及其父节点（Context）的7:3视图。

*   **细化交互：窗口比例的“呼吸感”**
    *   **悬停放大 (Hover Glance)**：为方便用户在不切换焦点的情况下快速查阅上下文，当光标在左侧30%的Context窗口悬停超过500ms，该窗口会临时扩张至40%，主窗口则被压缩。光标移开后，布局恢复。

### 1.3 窗口切换与比例调整交互增强

为赋予用户更高的掌控感，系统支持通过地图导航和可拖动的分割条来调整窗口布局。

#### **1.3.1 地图导航与弹性分割条交互设计**

*   **交互细节一：地图即导航**
    *   **点击激活**：在顶部缩略图或全景地图上单击任意节点，主画布会立即刷新。被点击的节点成为新的Primary窗口（70%），其父节点自动成为Context窗口（30%）。
    *   **过渡动画**：画布切换采用“非对称横移”效果，模拟在无限画布上移动相机的感觉，避免因瞬间刷新导致的空间感丢失。

*   **交互细节二：弹性分割条**
    *   **视觉形态**：两窗之间存在一个4px宽的隐藏热区，光标悬停时显示为一条可拖动的细线。
    *   **吸附逻辑 (Snapping)**：
        *   在拖动至 **7:3**（或3:7）和 **5:5** 的比例时，会产生轻微的物理吸附感。
        *   当向一侧拖动到极限（如小于5%）时，较小的窗口会自动折叠为仅显示标题的窄条。
    *   **重置机制**：**双击**分割条，布局比例立即恢复为默认的7:3。

*   **压力测试与解决方案**
    *   **问题**：缩略图节点密集可能导致误触。
    *   **解决方案**：由于缩略图在任何时刻仅呈现不多于4个核心交互节点（父、己、两个平级），节点间距足够大，天然规避了误触风险，无需设计额外的碰撞热区。

*   **交互规范总结**
    *   **单击地图节点**：主画布切换，目标节点与其父节点按7:3呈现。
    *   **拖动分割条**：实时改变两窗比例，窗内内容（代码、公式）需做响应式适配。
    *   **双击分割条**：比例恢复至默认的7:3。

### 1.4 极限比例与缩略图节点数规范

为确保UI在极端操作下的稳定性和可读性，对窗口比例和缩略图显示制定严格的边界规范。

#### **1.4.1 2-Window极限比例与无记忆刷新机制**

*   **极限比例与UI熔断机制**
    *   **最小比例锁定**：用户可通过拖动分割条调整比例，但任一窗口的最小宽度都**不得低于30%**。即比例范围锁定在 `7:3` 到 `3:7` 之间。
    *   **物理反馈**：当拖动到达30%的边界时，分割条会停止移动，并伴有轻微的回弹（Rubber Banding）动效和颜色闪烁（如橙色）的视觉警告，提示已达极限。

*   **回顾：为什么缩略图只需要4个节点？**
    *   缩略图的设计严格遵循“极简信息”原则，在任何时刻仅显示与当前上下文最直接相关的4个节点：
        1.  **父节点 (L n-1)**：1个，提供回溯入口。
        2.  **当前节点 (L n)**：1个，逻辑核心。
        3.  **平级节点 (Siblings)**：最多2个，展示横向探索的可能性。
    *   这种设计确保了极低的信息密度，从而保证了交互的准确性。

*   **2-Window切换与比例重置逻辑**
    *   **无记忆刷新**：系统**不记忆**用户手动调整的窗口比例。
    *   **重置时机**：只要发生层级切换（如 `Dive-in` 或通过地图 `Jump`），窗口比例将**强制重置**回默认的 **7:3**。
    *   **设计意图**：将手动调整定义为一种“临时审视行为”，确保每次进入新的学习单元时，用户都面对一个标准、可预测的布局。

*   **地铁缩略图的“实时动态”映射**
    *   顶部缩略图的“视口高亮框”的内部宽度比例，会实时、精确地反映主画布上两个窗口的比例。若用户拖动至5:5，高亮框的内部分隔也会移动到中点。

### 1.5 界面布局比例调整：7:3极限值

最终裁定，双窗模式的极限比例为 **7:3**。该决策旨在保障上下文窗口（Context Window）在所有主流设备上均具备有效的“参考可读性”。

#### **1.5.1 7:3极限比例下的UI/UX深度设计**

*   **物理反馈：硬性触底机制**
    *   当分割条被拖动至30%的“红线”位置时，将触发明确的**硬阻尼感（Hard Stop）**和视觉警告（如边缘发光或颜色变化），并伴随物理回弹效果，明确告知用户已达布局极限。

*   **30%空间内的内容降级策略**
    *   当一个窗口被压缩至30%宽度时，其内容会自动进入“摘要视图”或“极窄模式”：
        *   **排版调整**：取消段落首行缩进，采用左对齐，并适当加宽段间距以补偿横向空间的不足。
        *   **元素隐藏**：隐藏复杂的图表、图片等非文本元素。
        *   **信息聚焦**：内容自动切换为**“[加粗标题] + [关键结论摘要]”**的极简模式，确保在有限空间内信息密度依然有效。

*   **压力测试**
    *   **问题**：即使在30%宽度下，某些长代码或公式依然难以阅读。
    *   **解决方案**：该窗口内的代码块和公式将采用后述的响应式排版设计进行适配。

*   **2-Window比例与缩略图的联动**
    *   顶部缩略图的“视口高亮框”将严格锁定其内部比例，与主画布的7:3极限值保持一致，实现微观操作与宏观地图的视觉同步。

### 1.6 Primary Window内容排版适配

为应对用户在 `7:3` 到 `3:7` 比例范围内自由拖动导致的窗口宽度变化，主窗口（Primary Window）内的代码块和数学公式必须具备响应式排版能力。

#### **1.6.1 代码块与数学公式响应式排版设计**

*   **代码块排版设计**
    *   **宽屏态 (宽度 > 600px)**：采用IDE标准模式，保留左侧行号，长代码行出现水平滚动条，右上角提供“复制”按钮。
    *   **窄屏态 (宽度 < 300px)**：进入极简阅读模式。
        *   **隐藏行号**以释放空间。
        *   自动开启**语义化软换行 (Soft Wrap)**，并在换行处显示 `↩` 图标。
        *   字号从14px动态降至12px。
        *   增加一个“全屏查看”的浮动按钮，点击后以模态框形式展示代码。

*   **数学公式排版设计**
    *   **弹性缩放 (Auto-Scaling)**：当窗口宽度缩小时，公式整体等比例缩小，直至达到原始尺寸的70%。
    *   **溢出处理**：若缩放后仍无法容纳，公式容器将出现水平滚动条，并在左右两侧显示渐变遮罩以提示可滑动。
    *   **分段渲染 (Breakable Equations)**：对于包含多个等号的长公式，利用渲染引擎（如KaTeX）的 `allow-break` 属性，在等号处进行自动断行重排。

*   **响应式断点规范**

| 宽度区间 (W)       | 布局策略 | 代码块表现                       | 公式表现                     |
| ------------------ | -------- | -------------------------------- | ---------------------------- |
| > 600px (宽)       | 完整模式 | 显示行号 + 横向滚动              | 原始比例展示                 |
| 300px - 600px (中) | 混合模式 | 隐藏行号                         | 自动等比缩放 (70%-100%)      |
| < 300px (窄)       | 极简模式 | 强制折行 + 缩小字号              | 锁定70%大小 + 横向滑动       |

*   **跨窗口的视觉对齐**
    *   **性能优化**：在用户拖动分割条的过程中，代码和公式进入“骨架屏”或“简化渲染”状态，以保证60FPS的流畅体验。拖动停止后，再执行最终的高亮重绘。
    *   **焦点锚定**：在调整比例后，用户调整前正在阅读的代码行应尽量保持在窗口的垂直中心位置，避免因重排版而丢失阅读焦点。

### 1.7 极限比例重申：7:3

再次确认，为保证产品在主流设备上的可用性和体验下限，双窗布局的极限比例被最终锁定为 **7:3**。

#### **1.7.1 7:3比例下的排版与交互优化**

*   **排版红利**
    *   **代码块**：在30%的上下文窗口中，不再完全隐藏行号，而是采用“迷你行号模式”，并允许代码在20-25个字符左右进行语义折行，保留了基本的代码结构可读性。
    *   **数学公式**：默认以85%的比例渲染，相比之前的70%极限值，清晰度显著提升。

*   **交互边界的重新锚定**
    *   在30%的边界点强化“硬阻尼”物理反馈，通过视觉和触感明确告知用户已达极限。
    *   70%的主画布将保持最佳阅读体验，每行字数控制在40-50个汉字。

*   **性能与感知优化**
    *   **防抖渲染 (Debounce)**：在用户拖动分割条时，对高消耗的渲染任务（如LaTeX）进行防抖处理，仅在拖动停止100ms后执行重绘。
    *   **逻辑同步**：Primary窗口和Context窗口在垂直滚动位置上应具备逻辑同步能力，例如，当主窗口滚动到某个知识点的第三段时，上下文窗口应自动定位到触发该知识点的对应段落。

## 2. 完整的知识地图界面设计

全景知识地图是用户进行全局回顾、逻辑溯源和跨节点跳转的核心枢纽。

### 2.1 全景知识地图UI/UX设计

全景地图是一个在无限画布上渲染的“逻辑星系”，其设计核心是“秩序感”而非“艺术感”。

*   **视觉语言：无限画布上的“逻辑星系”**
    *   **布局逻辑 (Causal Flow)**：
        *   **X轴 (横向)**：代表逻辑深度（L1, L2, ... Ln）。
        *   **Y轴 (纵向)**：代表同一深度下的平级探索。
    *   **节点形态 (Node Anatomy)**：
        *   **标准节点**：直径为12px-16px的实心圆点。
        *   **当前焦点**：在地图中，代表当前2-Window模式下所处位置的节点，会带有持续的“呼吸光圈”效果。
    *   **连接线**：严格采用“地铁式正交折线”（Rounded Orthogonal Polylines），仅允许90度和45度转角，并设置8px-12px的圆角半径。**严禁使用自由曲线**。

*   **交互机制：从“看”到“跳”**
    *   **全景缩放 (Zoom & Pan)**：支持鼠标滚轮或双指进行无级缩放和平移。
    *   **语义缩放 (Semantic Zoom)**：
        *   当视图缩至极小（如<20%），节点上的标题将隐藏，仅显示逻辑线条的宏观走向。
        *   当视图放大（如>80%），节点会自动展示其内容的摘要卡片预览。
    *   **一键定位 (Jump-back)**：
        *   在地图中**双击**任意节点，全景界面将以“缩放并渐隐”的动效消失。
        *   主画布会立即重置为该节点（Primary 70%）及其父节点（Context 30%）的7:3布局。
    *   **路径隔离 (Path Isolation)**：单击任意节点，系统会高亮显示从根节点到该节点的唯一逻辑路径，其他所有无关分支将自动“幽灵化”（置灰并降至15%不透明度）。

*   **压力测试与解决方案**
    *   **长路径下的横向溢出**：引入“逻辑折叠”功能，用户可手动将某个分支节点后的所有子节点折叠为一个聚合图标（如`+15`），保持主视野的整洁。
    *   **多分枝导致的迷宫化**：强制执行“层级对齐”，所有同一深度的`Ln`节点在垂直轴线上严格对齐。

### 2.2 全景地图功能裁减与视觉优化

为聚焦核心功能，全景地图去除了“知识断层”和“复盘模式”等辅助功能，专注于导航与溯源。

#### **2.2.1 全景地图视觉语言与迷宫化解决方案**

*   **全景地图视觉语言：正交逻辑布局 (Ortho-Logical Blueprint)**
    *   **网格系统**：所有节点必须吸附在不可见的网格上，以保证布局的绝对工整。
        *   **X轴（深度轴）**：所有同级别的`Ln`节点必须在同一条垂直线上。
        *   **Y轴（关联轴）**：同级平级问题沿Y轴展开。
        *   **间距规范**：建议X轴间距为200px，Y轴间距为80px。
    *   **标签排版**：节点标题统一位于节点的右上角45度位置，采用12px非衬线字体，超过6个汉字自动省略，悬停显示全名。

*   **深度解决“迷宫化”：动态路径修剪与重力对齐**
    *   **严格列对齐机制**：强制所有`Ln`节点在垂直方向上对齐，即使用户的学习路径深度不一，也能通过垂直扫描快速判断节点的逻辑层级。
    *   **活跃路径高亮（核心机制）**：当用户处于某个对话中，全景图中从根节点到该节点的“亲缘路径”将以100%不透明度高亮显示。所有其他分支将被“幽灵化”（15%-20%不透明度，并移除文字标签），从而彻底消除视觉噪音。
    *   **动态分支避让算法**：系统实时计算各分支的垂直占用空间。如果一个分支的子节点过多，其下方的其他分支会自动在Y轴上下移，为其留出足够的“呼吸空间”，连接线则以90度折线清晰地展示绕行路径。

*   **交互体验：空间感知与瞬时跳转**
    *   **焦点重置**：界面右下角提供一个“定位当前”按钮，点击后画布会平滑移动并居中显示当前活跃的节点。
    *   **迷你预览 (Inset Map)**：在全景界面的角落提供一个微型缩略图，显示当前视口在整个知识地图中的宏观位置。

### 2.3 全景图与缩略图显示逻辑

全景图与缩略图在功能上是包含关系，而非并列关系。

#### **2.3.1 全景图空间转换与迷宫化治理**

*   **空间转换逻辑：从“局部”到“全景”的动效**
    *   **进入全景**：点击顶部缩略图时，该缩略图条会以中心为原点，用400ms的时间平滑地向四周扩张，直至铺满全屏。用户会感觉自己“钻入”了地图，而非打开了新页面。
    *   **退出全景**：双击节点返回时，整个全景画布会以目标节点为中心，迅速收缩回顶部80px高的缩略图区域。
    *   **状态同步**：进入全景模式时，顶部缩略图**自动隐藏**。

*   **深入探讨：如何彻底解决“迷宫化”**
    *   **“导航面包屑”悬浮层**：在全景图左上角，始终悬浮显示当前活跃路径的文字摘要（例如：`L1: 财务入门 > L2: 资产负债表`），作为用户的绝对位置参考。
    *   **“逻辑呼吸”动画**：当前2-Window模式对应的两个节点，在全景图中除了高亮外，还会有同步的、轻微的呼吸动效（光圈扩散），帮助用户在复杂视图中瞬间捕捉到自己的坐标。
    *   **垂直“泳道”视觉分割**：在地图背景层加入极淡的垂直网格线，每一列代表一个`Ln`深度，强化层级感。

*   **交互规范总结**

| 场景       | 顶部UI表现                         | 画布UI表现                                   |
| ---------- | ---------------------------------- | -------------------------------------------- |
| 工作区模式 | 显示缩略图 (4个核心节点)           | 2-Window (7:3 比例)                          |
| 全景图模式 | **隐藏缩略图**，显示路径面包屑     | 无限画布 (全量节点，正交布局)                |

### 2.4 重制主画布概念澄清

“重制主画布”是一个内部术语，指当用户从全景地图选择一个新节点进行跳转时，系统需要彻底刷新当前的2-Window工作区，以对齐新的逻辑位置。

#### **2.4.1 重制主画布的后端逻辑与设计师视角**

*   **内容重载**：Window A (70%) 加载被点击节点的对话记录，Window B (30%) 自动加载其父节点的内容。
*   **比例强制复位**：无论用户之前的布局比例如何，跳转后一律强制恢复为标准的7:3。
*   **状态锚定**：AI的底层上下文、顶部的缩略图高亮框等状态，全部切换到新的逻辑路径上。
*   **设计师视角**：这个过程不应是生硬的页面刷新，而是一个带有微小缩放动效（Zoom-in）的“视口跳转”，感觉是“俯冲”回具体的工作场景。

### 2.5 全景地图跳转交互方案裁决：方案A

在“直接重制”和“预览后重制”两个方案中，最终选择**方案A（直接重制）**，以追求专业工具的极致效率。

#### **2.5.1 全景地图跳转交互：瞬时重构设计**

*   **交互动作**：在全景地图中**双击**节点即触发跳转。
*   **视觉过渡**：
    *   全景画布以被点击节点为中心，轻微缩小并渐隐（Fade-out）。
    *   下方的2-Window工作区同时伴随一个从95%到100%的放大（Scale-in）效果。
    *   整个动效控制在**250ms - 300ms**内。
*   **内容填充**：为防止白屏闪烁，窗口内容加载采用**骨架屏（Skeleton Screen）**先行占位，文本随后流式渲染。
*   **认知引导**：
    *   **面包屑尾迹**：重制完成后的1秒内，主画布边缘可保留一道极淡的、指向其在缩略图中位置的线条，随后淡出。
    *   **标题闪烁**：新加载的Window A的标题栏会进行一次轻微的呼吸闪烁，明确告知用户焦点已切换。

### 2.6 动态窗口交互范式修正：焦点切换

对窗口切换的交互范式进行了最终修正，从“单向传送带”模式修正为“视口焦点切换”模式。

#### **2.6.1 呼吸式双窗切换交互设计**

*   **核心逻辑**：窗口的物理位置（父左子右）保持稳定，但“主场”身份和面积占比（70% vs 30%）随用户的逻辑流向而“呼吸式”切换。
*   **交互规范**

| 逻辑动作              | 视觉位移                             | 比例变化 (左:右) | 备注                                   |
| --------------------- | ------------------------------------ | ---------------- | -------------------------------------- |
| **Dive-in (新层级)**  | 挤压平移（旧左出，旧右变左，新右入） | 保持 3:7         | 产生物理位移，探索新领域               |
| **Back (回溯)**       | 原位比例调整                         | 由 3:7 变为 7:3  | **无物理位移**，焦点回到父级           |
| **Re-Focus (重回右侧)** | 原位比例调整                         | 由 7:3 恢复 3:7  | **无物理位移**，焦点回到子级进行再探索 |

*   **全局输入框**：输入框和光标焦点必须随Primary窗口的身份切换而移动。当左侧窗口成为主场时，输入框也应对齐到左侧。
*   **缩略图同步**：当发生“呼吸切换”时，缩略图上的高亮框无需大幅平移，只需在两个节点间切换其“视觉重心”（如大小、亮度变化），表示焦点已转移。