AI学习神器：重构知识构建——详细总结报告

## AI学习神器：用户痛点与产品愿景

### 用户痛点

1.  **Prompt调试困难，无法生成系统大纲**: AI在回答问题时只会一问一答，无法提供科学高效的课程大纲，导致学习效率分散，用户无法系统学习。
2.  **对话框内追问打乱学习节奏与上下文**: 在同一个对话框内追问不懂的小概念，会导致对话过长，原有教学节奏被打乱，上下文记忆被干扰，无法高效执行总体教学大纲。
3.  **多对话框切换低效，记忆互通性差**: 另开对话框追问会导致在不同窗口间切换，效率低下，且上下文记忆互通程度低。
4.  **对话内容无法系统总结为树状知识**: 提问过后，对话内容无法系统化总结为有效的树状知识结构。

### AI产品经理诊断与初步方案

1.  **核心痛点：线性对话流与结构化知识构建的矛盾**: 对话式AI（Chat）是线性的，而知识是多维网状的，因此不适合深度学习。
2.  **核心价值：将散点对话重构为非线性知识图谱**: 解决深度学习中的“路径迷失”与“认知负荷”问题。
3.  **初步评级：值得一试，挑战UI/UX范式革命**: 该产品痛点真实存在，但挑战在于UI/UX的范式革命，而非单纯的Prompt堆砌。

## MVP产品方案与设计迭代

### 第一轮MVP方案：AI学习IDE概念

1.  **压力测试：懒惰人性、巨头防御、Token成本**
    *   **懒惰人性**: 如何确保用户在提供完美树状结构后，仍能被驱动进行认知闭环，而非习惯性地“伸手要答案”？
    *   **巨头防御**: 面对OpenAI Canvas和Claude Artifacts已有的侧边栏补充/内容持久化功能，独立App如何保持竞争力？
    *   **Token成本**: 维持复杂树状教学大纲并插入细碎知识点，需要频繁调用长上下文，如何避免AI在深层分支时遗忘核心目标？
2.  **MVP优化方案：动态生成交互式教科书**
    *   **AI原生模块：多维画布、主干分支分离、ReAct自动化考纲**
        *   **多维画布**: 采用Canvas-based UI。
        *   **主干与分支分离**: 摒弃单一对话流，左侧固定显示主干大纲（固定步进），右侧点击触发“深度卡片”。
        *   **ReAct自动化考纲**: 用户输入学习主题后，Agent首先生成可交互知识树作为导航栏。
    *   **功能减法：砍掉社区功能，聚焦核心验证（支线不干扰主线）**
        *   **砍掉**: 复杂的社区功能、多模态笔记导出、花哨UI皮肤。
        *   **核心验证**: 确保用户在追问多个小概念后，能无感回到主线进度，且主线AI知道支线问题已解决。
3.  **技术落地路线图：大小模型组合、Neo4j图数据库、数据飞轮**
    *   **模型层**: 采用“大小模型组合”。主控使用Llama 3 70B或GPT-4o负责顶层逻辑和知识解构；支线使用Llama 3 8B或同级别模型负责解释通用小概念，降低延迟和成本。
    *   **数据层**: 利用图数据库Neo4j，将用户学习路径存储为知识图谱，节点为知识点，边为逻辑关系（递进、包含、对比），自动导出系统化总结。
    *   **数据飞轮**: 记录用户“追问”频率，若80%用户在某点卡住，系统自动将其加入主干考纲，实现产品自进化。
4.  **下一步行动：低代码原型测试（Notion/Obsidian手动模拟）**
    *   **准备**: 找5个非金融专业但想学金融的朋友。
    *   **实验**: 使用Notion或Obsidian手动扮演AI，观察用户在“手动非线性跳转”中的心理反馈。
    *   **观察**: 记录用户是否感到“不焦虑”，验证产品逻辑。

### 第二轮UI/UX方案：三层动态IDE布局

1.  **用户反馈与新问题：期望无限深挖、本地JSON存储、主画布占比**
    *   **无限深挖**: 用户计划最多做三级对话框，但希望能够无限追问，只要符合追问逻辑，即可无限分裂次级提问窗口。
    *   **本地JSON存储**: 建议将上下文以本地JSON文件形式储存记忆，随时调用，并调用各种turbo模型。
    *   **主画布占比**: 希望主画布占据大部分屏幕，侧边栏默认只显示一个窗口，L1回复时适当隐藏或缩小。
2.  **AI产品经理深入设计：MindWeave学习空间**
    *   **核心布局：三栏动态IDE结构（知识地图、主场画布、钻研抽屉）**
        *   **定位**: AI学习IDE，采用多栏弹性布局。
        *   **左侧：知识地图**: 垂直树状图，实时显示L1大纲，当前节点高亮，已完成节点置灰，既是目录也是快速跳转锚点。
        *   **中间：主场画布**: 宽屏文档流，L1教学区域，文字、代码块、数学公式以整洁格式呈现。
        *   **右侧：钻研抽屉**: 侧边栏，平时可收起，L2和L3对话发生在此，当用户提问主屏概念时，抽屉滑出，与左右侧保持引用关系。
    *   **核心交互：智能路由输入框（Magic Input）**
        *   **定位**: 产品灵魂，“意图指挥官”，位于底部中央。
        *   **视觉反馈：路由预判**: 用户输入时，输入框上方显示微型标签（Tag）及光标颜色，预判路由目标（L1主干、L2深入、L3补充）。
        *   **手动纠偏**: AI判断错误时，用户可按Tab键循环切换路由目标。
    *   **跨层级视觉关联：锚点链接、上下文呼吸特效**
        *   **锚点链接**: L2解决问题后，中间L1区域文本自动生成下划线或侧边图标，点击后右侧滑出“深挖对话”，实现知识可索引。
        *   **上下文呼吸特效**: L2提问时，L1内容轻微“发光”，提示用户当前提问的背景。
    *   **快捷操作逻辑：减少鼠标操作（Cmd+K, Cmd+J, Cmd+[ / ]）**
        *   **Cmd + K**: 唤起/聚焦输入框。
        *   **Cmd + J**: 收起/打开右侧Dive-in抽屉。
        *   **Cmd + [ / ]**: 在左侧知识树章节间快速跳转。
        *   **Enter**: 发送。**Shift + Enter**: 换行。
    *   **信息过载解决方案：自动收纳、主次分明**
        *   **自动收纳**: L2产生新深度对话时，旧L2对话自动折叠成“摘要卡片”。
        *   **主次分明**: 当前活跃层级100%不透明，非活跃层级（如背景主干大纲）降低至70%透明度，帮助用户聚焦。

### 第三轮布局与交互：无限分裂与两窗模式

1.  **布局进化：流式横向画布（River Flow）支持无限追问**
    *   **卡片层级化与水平位移逻辑**
        *   **卡片层级化**: 每个对话窗口（L1, L2, L3...）都是独立的“知识卡片”。
        *   **水平位移逻辑**: 用户唤起L2时，L2卡片右侧生成，L1自动向左平移并略微缩小、调低不透明度。L2唤起L3时，L3占据视觉中心，L1和L2像层叠的信封一样向左堆叠，但保留边缘可见。
    *   **焦点机制：高亮活跃窗口，因果路径连接**
        *   系统始终高亮当前活跃的Ln窗口，左侧所有父级窗口形成“因果路径”，视觉上用细长的连线贯穿。
2.  **知识地图：空间导航站（Minimap，Full Atlas）**
    *   **双态地图：常驻态（Minimap）、全景态（The Atlas）**
        *   **常驻态（Minimap）**: 屏幕顶部固定，高度约60px-80px，毛玻璃长方形条。极简线条，L1为粗灰线，Ln为细蓝线，节点为圆形实心点（已读）或空心点（未读）。采用“滑动窗口机制”，显示层级限制在“横3纵2”，L5时缩略图向左平移，只保留当前激活节点及父、祖父节点，视觉隐喻为地铁站台显示屏。主节点聚焦，只垂直向下（或向上）延伸最多2个平行节点。鼠标悬停非活跃节点才瞬时展示分支。
        *   **全景态（The Atlas）**: 用户点击缩略图或快捷键唤起时进入全屏层。功能定位为复盘、归纳、跨节点跳转。全局纵览不受“3横2纵”限制，展示完整知识树。热力轨迹表示对话轮数多、停留时间长的节点。语义聚合自动归纳同层级的平行问题为“知识簇”。
    *   **交互式回溯：节点即入口，路径高亮**
        *   **节点即入口**: 导图中的每个节点是“视口锚点”，点击L4节点，主画布平滑滚动到对应对话卡片。
        *   **路径高亮**: 选中深度节点时，地图高亮显示从L1到Ln的完整逻辑链条，过滤无关分支。
3.  **碎片补充窗口：卫星模式（Satellite Window）**
    *   **定位**: 悬浮气泡/侧边浮窗，不参与横向卡片流堆叠，像卫星般悬浮屏幕边缘。
    *   **无记忆隔离**: 视觉风格轻量（毛玻璃），提示为“临时仓库”，不影响主线卡片的逻辑堆叠。
4.  **自动化分支管理：智能收缩、单入口识别**
    *   **智能收缩（Auto-Collapsing）**: 用户在Ln层级深度探索时，系统自动将不再活跃的L(n-2)及以前的卡片折叠为竖状条（Spine）。折叠条保留该层核心关键词，鼠标扫过弹出预览。
    *   **单入口识别（The Router）**: L4窗口下方输入框提问时，AI逻辑判断关联性，若“Yes”则右侧弹出L5，若“No”则自动重定向到“卫星窗口”，L4界面不动。
5.  **记忆存储：知识元数据（Metadata）与结构化存储**
    *   **步进式总结**: 每级对话结束或停止输入30秒时，后台小模型生成“知识元数据”。
    *   **结构化存储**: Node = {Title, Summary, Keywords, ParentID, InteractionLogID}。
    *   **地图呈现**: 节点默认显示Title，长按显示Summary。

### 第四轮UI/UX：学习机制与反馈

1.  **学习机制诊断：因果链式学习与空间化解构**
    *   **核心机制**: 空间化解构，通过物理空间的延展，将复杂逻辑推导过程“显性化”。
    *   **评级**: 潜力无限，完美对齐“第一性原理”的学习法，但在“认知收敛”阶段存在设计挑战。
2.  **压力测试：局部深度导致全局迷失、过度依赖、知识碎片固化**
    *   **局部深度导致全局迷失**: 用户追问到深层（L5-L10）时，大脑易陷入细节“黑洞”，遗忘L1最初目标，UI机制缺乏“目标锚定”功能。
    *   **过度依赖**: 持续点击“为什么”或划选词条，学习易变成“消遣”，而非主动思考，UI交互缺乏“强制思考/内化”机制。
    *   **知识碎片固化**: 无限分裂产生大量知识碎片，“地图总结”是AI生成，UI是否支持用户手动标注、重组或合并这些碎片？
3.  **UI交互学习机制优化：收敛触发器、分屏对比**
    *   **收敛触发器（The Convergence Trigger）**
        *   **机制**: 深度超过3层（如L4）时，L1卡片上方出现“归纳提醒”。
        *   **UI交互**: 检测到Ln层问题解决（或手动标记“懂了”）时，Ln卡片向左“撞击”父级卡片，核心结论以“批注”形式吸附到父级节点上，模拟“知识收敛”。
    *   **分屏对比机制**
        *   **现状**: 卡片无限向右延展。
        *   **优化**: “对比学习”是核心，UI应支持用户从无限流中抽出任意两张卡片（如L1概念A和L5案例B）进行“垂直并列对比”。此时其他卡片半透明遮罩，强制引导用户进行跨层级逻辑关联。

### 第五轮UI/UX：盲点监测与交互

1.  **UI/UX深度设计：认知盲点监测**
    *   **视觉表征：卡片温度与应力系统（边缘应力、连接线震颤）**
        *   **卡片边缘应力（Edge Stress）**: 用户在某深度停留过久、反复对话或AI识别重复询问类似概念时，卡片边框从蓝色变为橙红色流光。隐喻为物理学“应力”，暗示认知负荷临界。
        *   **连接线震颤（Line Tremor）**: L4问题与L1核心目标偏差过大（逻辑断裂）时，连接线从实线变为虚线并频率震动。隐喻为“逻辑支撑点不稳”。
    *   **盲点触发态：认知雾化（局部雾化、回溯桥接浮窗）**
        *   **局部雾化效果**: 系统判定用户进入“死循环”或“盲区”时，活跃卡片背景轻微“雾化”（半透明模糊），遮住细碎文字，强迫用户停止阅读细节。
        *   **回溯桥接浮窗（Bridge Pop-up）**: 在雾化区域中心弹出2-3个“知识补丁”。UI呈现为“检测到可能在[概念A]上存在疑惑，是否需要先跳回[L1章节]复习一下[基础前提B]？”，点击“补丁”时，左侧父级卡片瞬间高亮，两张卡片间拉出金黄色导引线。
    *   **交互细节：热力图式进度条（Friction Bar）**
        *   **定位**: 卡片侧边或知识地图上，垂直的“认知摩擦力”进度条。
        *   **分段显示**: 每段对话对应条上的像素点。
        *   **颜色编码**: 绿色（顺畅），黄色（停顿），红色（摩擦）。
        *   **用户动作**: 用户点击红区，AI直接给出“破局建议”。
    *   **辅助干预：思维格式化工具栏（极简例子、可视化、自测）** (无结论，用户反馈剔除自测)
        *   **定位**: 监测到盲点时，输入框上方自动浮现三个“认知强拆”快捷键。
        *   **极简例子**: 中断术语堆砌，AI用5岁小孩能听懂的话重说。
        *   **可视化**: 调用多模态能力，生成流程图或对比表格。
    *   **盲点复盘记录：知识缺口档案（地图标记、挣扎摘要、对比式复习）**
        *   **地图标记**: 左侧全景地图中，触发过“应力”或“雾化”的节点，显示为“空心/破碎”视觉效果。隐喻为“未被完全消化的知识断层”。
        *   **内容沉淀：挣扎摘要（Struggle Summary）**: 带有盲点Ln窗口关闭或折叠时，AI生成“障碍描述”，而非结论总结。格式示例包括核心目标、卡点记录、原始语境。
        *   **交互触发：对比式复习（Comparative Review）**: 复习模式下点击“破碎节点”，UI采用双栏对比视图。左栏显示原始卡壳表述，右栏AI提供3个“重构方案”。用户点击“我现在懂了”并更新总结后，节点从“破碎”变为“实心”。
        *   **时间轴维度：认知衰减预警**: 盲点记录具备“半衰期”提醒。高摩擦、高难度盲点节点在地图上图标随时间缓慢脉动，提示用户遗忘风险。
2.  **用户反馈：剔除视觉干扰、不主动挑战**
    *   用户决定剔除应力、雾化等视觉干扰，不保留测验功能。核心挑战变为如何在不打扰用户“学习心流”的前提下，利用UI物理反馈实现最高效的预警与沉淀。

### 第六轮UI/UX：Ln窗口三向引导

1.  **核心价值：建立防溺水引导机制，AI升级为研究路径导航员**
    *   通过显性路径选项，将“无意识的连环提问”转化为“有意识的路径选择”，精准高效，AI从“答案提供者”升级为“研究路径导航员”。
2.  **Ln窗口三向引导深度设计**
    *   **拓扑引导（Horizontal Link）：留在当前卡片**
        *   **语义逻辑**: 寻找当前概念的同级关联或对照组，防止用户在不了解背景下孤军深入。
        *   **句法进化**: 避开“你想了解...吗”，改用对比或关联视角。示例：“通常与ROE结合看能发现财报修饰，要对比一下吗？”。
        *   **UI触感**: 建议放在左侧，点击后内容直接流式加载在当前卡片下方。
    *   **穿透引导（Vertical Dive）：开启Ln+1卡片**
        *   **语义逻辑**: 拆解当前概念的底层砖块，满足深度探索欲，明确告知将开启新窗口。
        *   **句法进化**: 强调因果逻辑或公式拆解。示例：“ROIC的波动核心在于资本占用(IC)的计算细节，要拆解它吗？”。
        *   **UI触感**: 建议放在中间，带有→符号。点击后，屏幕平滑向右滚动，生成Ln+1卡片。
    *   **收敛引导（Convergence Exit）：回到Ln-1或主干**
        *   **语义逻辑**: 将当前卡片的碎碎念，挂载回大纲目标，强制用户从细节跳出，重新锚定父级目标，完成认知闭环。
        *   **句法进化**: 强调结论输出与主线归位。示例：“细节已够，回到【公司基本面分析】环节看它如何定价？”。
        *   **UI触感**: 建议放在右侧。点击后，当前Ln卡片高亮并向左收缩，视觉焦点回到父级卡片。
3.  **压力测试：引导语相关性与视觉权重竞争**
    *   **风险1：引导语的“相关性”失效**: AI建议问题用户不感兴趣，三栏信息无效。
        *   **对策**: 后端采用Path-Aware Prompting，AI不仅看当前段话，还看“学习路径图”。用户连续Dive in 3次后，收敛引导权重和说服力自动调高。
    *   **风险2：视觉权重的竞争**: 三个按钮并排，用户可能“选择困难”。
        *   **对策**: 引入“默认高亮路径”，根据用户学习习惯或课程难度，系统微弱高亮其中一个。

### 第七轮UI/UX：界面动态布局与跳转

1.  **AI产品经理修正：7:3双窗架构下的视口焦点切换**
    *   **核心价值：原位回溯机制，动态平衡体**
        *   通过改变窗口比例实现“逻辑主场”的瞬间反转，保持物理位置稳定性（父左子右），降低用户空间辨别成本。UI从“单向流”进化为“动态平衡体”。
    *   **交互重构：呼吸式双窗切换（前进与后退）**
        *   **逆向逻辑：回溯（The Back-track）**
            *   **初始状态**: [Window Left: Context (30%)] | [Window Right: Primary (70%)]。
            *   **触发动作**: 点击建议栏中“回到上一级”。
            *   **交互表现**: 比例反转（分割线平滑向右移动至7:3），身份互换（左侧窗口重新激活为Primary，右侧进入静默态变为Context），视觉目的为拉近左边卡片。
        *   **正向逻辑：再次钻研（The Re-Dive）**
            *   **状态**: [Window Left: Primary (70%)] | [Window Right: Context (30%)]。
            *   **动作**: 再次对右侧内容感兴趣，或从左侧开启新钻研。
            *   **交互表现**: 分割线平滑向左移动，恢复为3:7（左30%，右70%），右侧重新夺回主场。
    *   **顶部缩略图：焦点呼吸同步**
        *   **高亮方括号（Viewport Bracket）**: 用户点击“回溯”时，高亮括号不需大幅平移，向左“侧重”，视觉呈现为括号在缩略图节点间切换“重心”。Ln-1节点变亮变大，Ln节点变小变暗。
2.  **压力测试：无限深度平移、左右Primary视觉歧义**
    *   **风险1：无限深度的“平移”何时发生？** (无结论，但AI产品经理补充了闭环逻辑：只有当用户决定开启一个“当前屏幕上不存在”的层级时，才执行“挤压平移”逻辑。)
        *   **对策**: (如上，通过闭环逻辑解决)
    *   **风险2：左右Primary的视觉歧义。**
        *   **对策**: “全局输入框”必须随焦点移动。如果左侧是Primary，光标和输入引导应物理对齐到左侧中心。

### 第八轮UI/UX：代码与公式排版

1.  **AI产品经理修正：7:3比例下的排版红利**
    *   **代码块排版：从残缺转向预览（迷你行号、语义折行）**
        *   **30%宽度下**: 采用“迷你行号模式”（占20px），代码在20-25字符左右进行语义折行。用户一眼看出父级代码结构。
    *   **数学公式排版：从遮挡转向缩放（完整显示、温和缩放）**
        *   **30%宽度下**: 大多数标准LaTeX公式（如E = mc²）可完整显示。
        *   **缩放策略**: 公式在30%窗口内默认以85%比例渲染，比70%极限缩放更清晰。
2.  **交互边界重新锚定：硬阻尼点、信息密度切换**
    *   **硬阻尼点（The 30% Snap）**: 分割条向左滑动至30%位置时，触发物理回弹和红色边缘预警。
    *   **信息密度切换**: 70%主画布维持“黄金阅读区”，每行40-50汉字；30%辅助窗自动切换为“摘要视图”，取消首行缩进，采用左对齐，段间距加宽，增加垂直空间补偿横向空间不足。
3.  **性能与感知优化：Debounce渲染、视觉对齐**
    *   **Debounce（防抖）渲染**: 快速拖动分割条时，Context窗口内公式使用“图片占位符”或“简化字符”代替实时LaTeX渲染。鼠标松开100ms内，执行完整的KaTeX重绘。
    *   **视觉对齐**: 确保Primary (70%)和Context (30%)在垂直滚动位置上具有“逻辑同步”。

## 核心工作流：SOP学习流程

### AI产品经理重构：模糊意图到结构化契约

1.  **核心价值：建立学习契约，降低认知负荷**
    *   通过前置结构化拆解，将用户认知负荷从“思考下一步学什么”中解放，全身心投入“理解当前内容”。评级为“至关重要”，SOP质量直接决定“无限分裂”窗口逻辑连贯性。
2.  **启动学习SOP：意图锚定 -> 蓝图生成 -> 路径裁剪 -> 仪式化入场**
    *   **Step 1: 种子输入与意图对齐（学习意向表单）**
        *   **设计动作**: 提供“学习意向表单”，非空白对话框。
        *   **交互细节**: 点击“新建学习”弹出半透明覆盖层，询问目标主题、现有水平、期望深度。
        *   **目的**: 强制用户开始前进行微小元认知审视，防止AI生成大纲过浅或过深。
    *   **Step 2: 全景蓝图生成（地铁线路图）**
        *   **设计动作**: AI不直接开启L1对话，而是先打开“全景知识地图”。
        *   **交互细节**: 地图上出现动态生成的“地铁线路图”，展示L₁到Ln的预设主航道和关键换乘站。
        *   **目的**: 让用户在细节学习前，先获得全局空间感。
    *   **Step 3: 交互式路径确认（剪枝、调序）**
        *   **设计动作**: 用户在地图上对大纲进行“剪枝”。
        *   **交互细节**: 用户可点击地图节点说“这部分我懂了，跳过”；用户可拖拽调整章节顺序。
        *   **目的**: 建立“参与感”，用户修改后的大纲从“AI的大纲”变为“我的大纲”。
    *   **Step 4: 沉浸式入场（俯冲动效）**
        *   **设计动作**: 从全景图“俯冲”进入工作区。
        *   **交互细节**: 用户点击“开始学习”后，地图以L₁节点为中心迅速缩放，背景渐隐。Window A (Primary)出现第一节内容，顶部缩略图刷新出前四个节点。
        *   **目的**: 通过视觉切换建立“学习仪式感”，进入沉浸状态。

### 压力测试：大纲生成速度与用户拒绝

1.  **慢生成对策：渐进式渲染、思考中脉动**
    *   **对策**: 采用“渐进式渲染”，先出主轴（L1），再出支流（L2）。全景图中增加“思考中”的脉动效果，让用户看到AI正在编织知识网。
2.  **拒绝大纲对策：自由探索入口、系统提醒**
    *   **对策**: 提供“自由探索”入口，点击后绕过SOP直接进入空白卡片，但系统应随时提醒“这看起来是一个大课题，是否需要为你构建系统大纲？”。

### 关键模块设计：大纲生成Prompt逻辑

1.  **Planning Agent：基于第一性原理的解构**
    *   大纲生成Prompt底层逻辑：将复杂系统性知识拆解为“原子级主干”与“可预测分支”。
    *   **L1 (Trunk)**: 学科“骨架”，强线性逻辑。
    *   **预设L2 (Dive-in)**: AI预先识别“认知门槛”，标记为潜在深度钻研点。
    *   **平行节点(Parallel)**: AI预判具有对比性的知识点。
2.  **Prompt架构：角色定义、输入参数、输出约束、教学法原则**
    *   **A. 系统指令(System Role)**: AI是拥有20年经验的课程设计师，擅长将复杂学科通过“第一性原理”拆解为逻辑严密地铁线路图，目标是输出AI学习IDE使用的结构化JSON。
    *   **B. 输入参数(Injected Parameters)**: Topic（用户输入）、User_Level（入门/进阶/专家）、Depth_Expectation（快速扫盲/系统构建/工程实践）、Constraint（“仅输出主干节点(Trunk)，且节点数量控制在5-8个。”）。
    *   **C. 核心输出约束(Output Schema)**: AI严格按指定JSON结构返回，不准输出废话。
3.  **教学法指令：确保非线性可能性（parallel_seeds, dive_in_seeds）**
    *   每个L1节点自带2个parallel_seeds和2个dive_in_seeds，作为新窗口初始Prompt，实现极速响应。
    *   针对User_Level调整术语密度，零基础用户title使用具象化语言。

## 后端逻辑与数据管理

### AI产品经理重构：对话框后端逻辑（Orchestration Layer）

1.  **核心逻辑概览：上下文路由与状态机闭环**
    *   后端核心任务是处理“上下文路由与状态机”闭环。
    *   **输入**: 用户Prompt + 当前视口状态 (active_node_id, parent_node_id)。
    *   **处理**: 意图识别 -> 上下文组装 -> 知识库检索 (RAG) -> 模型推理 -> 状态更新。
    *   **输出**: 分流回复内容 + 知识地图更新指令 (JSON)。
2.  **意图路由引擎：低延迟模型分类（STAY, DIVE, BACK, JUMP, TANGENT）**
    *   系统使用GPT-4o-mini或本地Qwen-1.5B作为前置分类器。
    *   **意图分类协议**: 根据用户输入，将意图分为五类：
        *   **STAY (平行/继续)**: 针对当前Ln的后续追问，追加至当前Node对话历史。
        *   **DIVE (向下钻研)**: 针对特定概念深挖，创建新Node ID，父ID指向当前。
        *   **BACK (逻辑收敛)**: 明确表达“我懂了”、“回到主线”，触发主画布比例切换（7:3反转）。
        *   **JUMP (地图跳转)**: 点击缩略图或全景图节点，重制主画布，加载目标Node对话。
        *   **TANGENT (碎片/离题)**: 与当前学习链条无关，路由至卫星窗口，不记录在主链。
3.  **上下文工程：树状记忆协议（路径压缩上下文）**
    *   为节省Token并防止“幻觉”，不发送全量历史，采用“路径压缩上下文”。
    *   **上下文组装公式**: Ctotal = Csystem + Cpath_summary + Cparent_window + Cactive_window
        *   **Csystem**: 核心指令（导师、学科背景、输出格式要求）。
        *   **Cpath_summary**: L1到Ln-1路径摘要。
        *   **Cparent_window**: 当前左侧窗口（30%）的最后2轮对话。
        *   **Cactive_window**: 当前右侧窗口（70%）的完整当前对话。
    *   **好处**: 即使追问到L10，模型仍知身处何方，但只消耗极少Token。
4.  **知识地图后端状态机：JSON知识树持久化**
    *   后端维护持久化的JSON知识树，作为“重制主画布”和“全景地图”的数据源。
    *   **自动总结**: 用户离开节点时，后端异步启动低成本模型，将节点对话总结为100字以内的summary。

### 大纲动态重同步（Manual Modification & Syllabus Re-Sync）

1.  **局部语义重新建模：种子刷新任务**
    *   **场景**: 用户将“资产负债表入门”重命名为“中概股财报中的资产科目陷阱”。
    *   **后端动作**: 不重新生成整个大纲，针对该节点触发“种子刷新任务”。
    *   **Prompt逻辑**: 基于父子节点，用户重命名当前节点后，重新生成适配新主题的2个parallel_seeds和2个dive_in_seeds。
2.  **逻辑链条一致性检查：逻辑桥接**
    *   **场景**: 用户删除了L₁中的第三章。
    *   **后端动作**: 触发“逻辑桥接”。AI检查第四章的context_requirement，若发现断层，自动修改第四章初始Prompt，补齐被删除章节的核心前置知识。
3.  **拓扑状态持久化：实时写入study_session.json**
    *   所有手动修改实时写入本地的study_session.json，作为主画布渲染的“单一事实来源”。

### 记忆加载协议（Hierarchical Context Hydration Protocol）

1.  **核心目标：快速冷启动UI渲染和AI记忆恢复**
    *   实现<300ms的冷启动UI渲染和<1s的AI记忆恢复。
    *   **关键策略**: “知识地图(JSON树)”与“节点内容(Blobs)”分离存储，启动时只恢复地图和最后两个窗口，其他内容后台静默预加载。
    *   **核心理念**: 结构先行，内容懒加载，记忆按需重组。
2.  **数据存储架构：双层异构存储（Skeleton/Muscle Layer）**
    *   本地数据结构分为两部分：
        *   **骨架层(The Skeleton)**: `session_graph.json`，体积极小(<50KB)。内容包含节点ID、标题、父子关系、位置、状态、path_summary。驱动顶部缩略图、全景地图瞬间渲染。
        *   **肌肉层(The Muscle)**: `node_content_{id}.db`，体积较大(每节点KB到MB)。内容包含完整对话记录、代码块、LaTeX源码。填充主画布。
3.  **冷启动加载时序：骨架渲染 -> 视口水合 -> 记忆重组**
    *   **T+Oms: 骨架渲染**: 读取`session_graph.json`。UI动作：顶部“地铁缩略图”瞬间出现，全景地图数据准备就绪。定位：读取`last_active_node_id`。
    *   **T+100ms: 视口水合(Viewport Hydration)**: UI动作：主画布出现骨架屏。数据读取：并行从IndexedDB读取`last_active_node_id`和`parent_node_id`的完整对话记录。渲染：7:3窗口瞬间填充文本。
    *   **T+500ms: 记忆重组(Memory Reconstruction)**: 后台静默构建LLM的System Prompt。发送全局目标、路径面包屑、活跃上下文。
    *   **T+1000ms: 连接就绪**: LLM初始化完成，输入框解除锁定。
4.  **核心难点：离场总结机制（On-Exit Summarization）**
    *   **机制**: 用户在L窗口停留超过3分钟，或点击Dive-in离开窗口时，后端触发轻量级后台任务。
    *   **动作**: 调用小模型（如GPT-4o-mini）将窗口核心结论压缩成100字以内摘要，写入`session_graph.json`的summary字段。
    *   **冷启动收益**: 第二天LLM直接读取摘要，实现“连续性记忆”。
5.  **压力测试：摘要丢失、冷启动后跳回L1**
    *   **场景1：摘要丢失怎么办？**
        *   **对策**: 冷启动时，若路径节点缺少摘要，即时触发后台总结任务，总结生成前，向LLM发送该节点最后3条原始对话作为替补。
    *   **场景2：用户冷启动后，立刻点击地图跳回L1。**
        *   **对策**: 实现“视口预测(Viewport Prediction)”，鼠标悬停地图节点200ms以上，系统优先预加载该节点的文本数据。
6.  **交互体验：无缝衔接的“开场白”（幽灵提示）**
    *   **智能唤醒（Smart Wake-up）**: 基于Active Node状态，系统自动在输入框上方生成“幽灵提示”。
    *   **实现**: 本地规则生成的文案，无需消耗LLM Token，提供“被关注感”。

### 本地存储与索引实现方案

1.  **架构概览：双层异构存储（IndexedDB Object/Key-Value Store）**
    *   数据分为轻量级关系数据和重量级非结构化数据。
        *   **Tier 1: 骨架层**: IndexedDB (Object Store)，JSON树状结构，极高频读写，<1MB。驱动全景地图、缩略图、SOP逻辑。
        *   **Tier 2: 肌肉层**: IndexedDB (Key-Value)，Blob/文本流，低频按需加载，数十MB。填充L对话窗口、代码块、公式。
    *   **技术选型建议**: 使用Dexie.js或idb库进行封装，而非直接原生IndexedDB API。
2.  **数据库Schema设计：SessionGraph（骨架层）与NodeContent（肌肉层）**
    *   **A. 骨架层: SessionGraph (The Map)**: 导航仪，任何对地图的增删改查都在此发生。
        *   `interface NodeMeta`: 包含id, parentId, title, summary, depth, status, seeds等元数据。
    *   **B. 肌肉层: NodeContent (The Chat Logs)**: 存储“重资产”的地方。
        *   `interface NodeContent`: 包含nodeId, messages（含role, content, timestamp, meta等）。
3.  **关键性能优化：写入缓冲池（Debounced Flush）**
    *   **流式接收**: AI生成token暂存在前端JavaScript变量，实时驱动UI渲染。
    *   **防抖写入**: 设置定时器（2000ms）或检测“句号/换行符”，当缓冲区积累一定量文本或AI暂停输出时，触发db.nodeContent.put()。
    *   **异常保护**: 监听beforeunload事件，用户突然关闭网页时强制执行flushSync()，数据写入IndexedDB。
4.  **冷启动加速方案：复合索引与视口预判预加载**
    *   **A. 复合索引(Compound Indexes)**: 在NodeContent表中建立`[sessionId + lastAccessed]`索引，快速找出“最近常看的10个节点”。
    *   **B. 视口预判算法(Viewport Prediction Algorithm)**: 使用`requestIdleCallback`进行静默预加载。
        *   **T0**: 加载骨架层，渲染地图。
        *   **T1**: 立即加载Active Node和Parent Node的内容。
        *   **Idle Time**: 计算全景地图中Active Node的“邻居节点”，后台静默读取并缓存到内存。
    *   **效果**: 用户点击“平行扩展”或“返回上一级”时，内容瞬开。
5.  **数据安全与导出格式：同源策略、JSON压缩加密**
    *   **数据隔离**: IndexedDB遵循同源策略。
    *   **JSON导出格式**: 用户选择“导出.mind文件”时，系统将SessionGraph和NodeContent打包。
    *   **压缩**: 使用pako压缩JSON字符串，体积减小70%。
    *   **加密(可选)**: 用户开启隐私模式时，导出前使用AES-GCM加密content字段。
6.  **代码层面实现伪代码**: 提供了基于Dexie.js的极简实现范例。
    *   **模块设计结论**: 选型Dexie.js，策略骨架与肌肉分离，优化写入靠防抖，读取靠预加载。结构严格的Schema约束，确保导出JSON干净。支撑10万+节点流畅运行，冷启动时间控制在200ms内。

## 成果输出与分享

### AI产品经理定位：个人知识出版中心

1.  **核心理念：从对话到人工制品（Smart Compiler）**
    *   用户痛点是对话散乱，知识需整理。解决方案是Smart Compiler（智能编译器）。
2.  **导出前置处理：去噪、结构化、格式化**
    *   导出前，系统通过后台Agent执行“清洗与重组”：
        *   **去噪**: 删除寒暄、重复追问、错误废弃分支。
        *   **结构化**: L₁识别为一级标题(H1)，Ln识别为子标题(H2/H3)。
        *   **格式化**: 统一修复LaTeX公式渲染、代码块高亮。

### 导出场景拆解

1.  **线性化出版：PDF/Word（Textbook Mode）**
    *   **适用场景**: 用户想将探究变成《ROIC深度指南》发给老板或打印复习。
    *   **设计形态**:
        *   **封面**: 自动生成标题、学习时间、全景知识地图高清截图。
        *   **目录**: 基于JSON树生成自动跳转目录。
        *   **正文排版**: 对话气泡消失，转化为正规文档流。用户提问转化为小标题或加粗引导语。AI回答转化为正文段落。脚注：文中引用平行节点在PDF中以侧边批注或页脚形式呈现。
2.  **记忆切片：Anki/apkg（Memory Card）**
    *   **适用场景**: 用户学完后，通过间隔重复记忆知识。
    *   **功能设计**: “一键制卡”。系统识别所有Ln节点。
    *   **正面(Front)**: 节点标题。
    *   **背面(Back)**: AI自动生成100字摘要+核心公式。
    *   用户直接下载.apkg文件，导入Anki开始背诵。

### UI/UX设计：导出面板（成果结算页面）

1.  **面板布局与选项：预览区、范围选择、清洗力度、格式卡片**
    *   **入口**: 全景地图界面右上角，图标为“输出/保存”。
    *   **面板布局**: 左侧预览区实时显示PDF首页或Markdown结构树；右侧选项区。
    *   **范围选择**: “导出全图”vs“仅导出当前分支”。
    *   **清洗力度**: “保留完整对话”vs“整理为教科书”。
    *   **格式卡片**: 巨大的图标选项 [PDF] [Markdown] [Notion] [Anki]。
2.  **Loading动效：编译知识图谱动画**
    *   点击导出后，显示“正在编译知识图谱...”，伴随进度条扫描JSON树动画，强化“生产力”心理暗示。

### 后端技术方案：Pandoc与AST

1.  **中间格式：JSON树转Pandoc AST**
    *   后端将清洗后的JSON树转换为Pandoc AST（抽象语法树）。
2.  **转换管道：AST到LaTeX/CommonMark/Notion API**
    *   **AST → LaTeX → PDF**: 利用LaTeX引擎实现完美公式排版。
    *   **AST → CommonMark → Markdown**。
3.  **压力测试：Notion API限流、PDF代码块截断**
    *   **问题1：Notion API经常限流或超时，导致导出失败。**
        *   **对策**: 采用异步队列。用户点击“导出到Notion”后，UI提示“后台正在传输，完成后通知你”，不阻塞用户操作。
    *   **问题2：PDF里的代码块太长，被截断了。**
        *   **对策**: PDF渲染引擎包含“自动换行与缩放”逻辑。代码行过长时，自动缩小字号或强制折行，严禁截断。

## 产品终稿与开发排期

### MindWeave V1.0最终产品规格书

1.  **核心界面架构：双窗模式、空间交互、边界反馈**
    *   **布局逻辑**: 双窗模式（7:3比例）。左窗（Context, 30%）为父级节点，内容降级为“摘要视图”，隐藏行号，公式缩放85%。右窗（Primary, 70%）为当前活跃节点，完整渲染，IDE级代码体验。
    *   **空间交互**: Dive-in（深入）采用“挤压平移”动效；Back（回溯）采用“呼吸切换”，无位移，分割线右移，左窗变大为Primary，右窗变小为参考。
    *   **边界反馈**: 拖动分割条至30%处触发硬阻尼和红色边缘提示。
2.  **导航系统：顶部缩略图、全景地图、跳转逻辑**
    *   **顶部缩略图(The Subway HUD)**: 扁平长条，高度80px，仅显示4个核心节点（父、己、2个平行建议）。滑动取景框实时同步主画布分割比例。
    *   **全景地图(The Orthogonal Map)**: 地铁线路图风格，正交折线（90度/45度），节点垂直列对齐。迷宫治理：仅高亮“活跃路径”，其余分支“幽灵化”（置灰）。面包屑导航悬浮左上角。
    *   **跳转逻辑**: 双击即跳转（方案A），地图缩小渐隐，主画布缩放显现，强制重置为7:3布局。
3.  **引导与生成：SOP启动、Ln对话引导**
    *   **SOP启动**: 意图锚定（表单）→蓝图生成（全景图）→路径确认（剪枝）→沉浸入场（L1）。
    *   **Ln对话引导**: 位于回答末尾的三栏建议：[平行扩展]、[深层穿透→]、[逻辑收敛←]。内容生成基于parallel_seeds和dive_in_seeds实现毫秒级响应。
4.  **后端大脑：架构、存储、冷启动协议、离场总结**
    *   **架构**: 状态路由机（Stateful Router）。
    *   **存储**: Graph (JSON)存骨架和摘要；Content (IndexedDB)存全量文本。
    *   **冷启动协议**: 优先渲染UI骨架→并行加载最后两窗文本→后台重组LLM上下文。
    *   **离场总结(Summary-on-Exit)**: 离开节点即触发后台总结，确保记忆链条轻量化。
5.  **成果输出：教材编译、记忆切片**
    *   **教材编译(PDF Export)**: 智能清洗废话，JSON树编译为线性章节。使用LaTeX引擎渲染完美公式，代码块自动换行不截断。自动生成封面、目录和全景图索引页。
    *   **记忆切片(Anki Export)**: 提取所有Ln节点。正面：标题；背面：AI摘要+核心公式。导出.apkg文件。

### 开发排期指令

1.  **Phase 1 (2周)**：完成后端JSON状态机与“大纲生成”Prompt调试。
2.  **Phase 2 (3周)**：前端核心攻坚——实现无缝的“2-Window挤压动画”与“正交全景地图”渲染。
3.  **Phase 3 (2周)**：接入LLM、调试冷启动速度与上下文压缩效果。
4.  **Phase 4 (1周)**：PDF/Anki导出功能开发与验收。