# PDF 转带行号文本 · 程序说明

本程序将「AI 与用户一问一答」的 PDF 对话记录转为带行号、且标注**问/答/正文**的纯文本，便于后续引用、校对或分析。不调用大模型，仅依据 PDF 版面与坐标判断角色。

---

## 1. 功能概览

| 功能 | 说明 |
|------|------|
| **输入** | 单份 PDF 文件（常规 A4 比例） |
| **输出** | `transcript_with_lines.txt`：UTF-8 纯文本，每行形如 `[L编号][角色] 文本` |
| **行号** | 全局连续：`[L1]`、`[L2]` … |
| **角色** | `[答]` = AI 回答，`[问]` = 用户提问，`[?]` = 正文或未区分 |
| **断句合并** | 同一角色内因 PDF 换行被拆成多行的句子会尽量合并为一行 |

---

## 2. 排版假设（与真实 PDF 一致）

- **纸张**：常规 A4 尺寸比例（宽约 595 pt，由 pdfplumber 的 `page.width` 或常量兜底）。
- **问答区域**：
  - **左栏**：AI 回答（如「AI 产品经理」等标识及对应正文）。
  - **右栏**：用户提问（如「自定义 Gem」侧或灰色框旁的用户内容）。
- **正文区域**：页面中**单栏**排版的标题、列表、说明等（如「Primary (80%)」「分流推进动画」「模块设计总结」等），不强行归入问或答。

程序通过**水平坐标**判断「左/右」，并**按页**判断该页是否为「双栏」；只有双栏页才打 `[答]`/`[问]`，单栏页统一打 `[?]`，避免把整页正文误标为答。

---

## 3. 处理流程（五步）

```
PDF 输入
   ↓
① 按页提取文本块（带 x0, top, page, page_width）
   ↓
② 按 (页码, 纵坐标 y, 横坐标 x) 排序 → 阅读顺序：先上后下、先左后右
   ↓
③ 按页做「双栏检测」：该页是否既有 x0<中线 又有 x0≥中线 的块？
   → 是：该页块按 x0 与中线比较，标 [答]/[问]
   → 否：该页块标 [?]（正文）
   ↓
④ 同一角色内做「断句合并」：不以句末标点结尾、且下一行非新句开头时合并为一行
   ↓
⑤ 写入 transcript_with_lines.txt，每行 [L编号][角色] 文本
```

---

## 4. 核心规则说明

### 4.1 中线与左右栏

- **中线**：`midline = page_width / 2`（A4 下约 297.64 pt）。
- **左栏**：文本块左边界 `x0 < midline` → 标为 **答**（AI）。
- **右栏**：文本块左边界 `x0 ≥ midline` → 标为 **问**（用户）。
- 若某块无坐标（如某页只能用 `extract_text` 回退），标为 **?**。

### 4.2 按页「双栏检测」

- 同一页内，若**既存在** `x0 < midline` 的块，**又存在** `x0 ≥ midline` 的块，则认为该页为**双栏布局**，才对该页块打 `[答]`/`[问]`。
- 若该页所有有坐标的块都在中线同一侧（例如整页单栏正文），则该页所有块标为 **?**，避免整页正文被标成「答」。

这样既适配「顶部单栏 + 底部左右分栏」的混合版式，又不会把纯正文页误判为问答。

### 4.3 断句合并（仅同角色内）

- 只对**角色相同**且**均非 ?** 的相邻行做合并。
- 满足下列之一则**不合并**，另起一行：
  - 上一行以句末标点结尾：`. ! ? 。！？;；`
  - 上一行以冒号结尾（如「问：」「答：」）
  - 当前行以「问：」「答：」「Q:」「A:」等开头
  - 角色不同或任一侧为 ?

合并时：上一行末与当前行首均为英文/数字则中间加空格，否则直接拼接（适配中英混排）。

---

## 5. 输出格式示例

```text
[L1][?] Primary (80%) 与 Context (20%) 的说明段落…
[L2][?] 分流推进动画 1. 第一步…
[L3][答] 收到，纠正得非常准确。「只显示两个窗口」是一个极其冷静且克制的工程决策…
[L4][问] 你想让我为你细化缩略图中「节点与节点之间」的连接线逻辑，还是讨论全景地图中的「一键定位回对话」？
[L5][?] 模块设计总结 1. 顶部缩略图…
```

- `[L n]`：全局行号，连续。
- `[答]` / `[问]`：仅双栏页且能根据 x0 区分时使用。
- `[?]`：单栏正文、无坐标块，或整页未形成左右两栏时使用。

---

## 6. 使用方式

### 6.1 本地运行

```bash
pip install pdfplumber
```

修改脚本内 `PDF_PATH` 为你的 PDF 路径，运行：

```bash
python pdf_to_line_numbered_text.py
```

输出文件默认为当前目录下的 `transcript_with_lines.txt`。

### 6.2 各 refine 文件夹内（本地运行）

`prompt_2_refine_process`、`prompt_3_refine_process` 下的 `colab_pdf_to_lines.py` 已改为**本地运行**：

```bash
cd prompt_2_refine_process   # 或 prompt_3_refine_process
pip install pdfplumber
python colab_pdf_to_lines.py              # 默认使用 ../../data/test_1.pdf
python colab_pdf_to_lines.py 路径/xx.pdf  # 指定 PDF
```

输出为当前文件夹下的 `prompt_2_refine_process_text.txt` 或 `prompt_3_refine_process_text.txt`。

---

## 7. 依赖与文件说明

| 依赖 | 用途 |
|------|------|
| **pdfplumber** | 按词/行提取文本及坐标（x0, top, page.width），保证阅读顺序与多栏处理 |

| 项目内文件 | 说明 |
|------------|------|
| `pdf_to_line_numbered_text.py` | 本地主脚本 |
| `prompt_2_refine_process/colab_pdf_to_lines.py`、`prompt_3_refine_process/colab_pdf_to_lines.py` | 本地运行，默认读 data/test_1.pdf，输出为当前文件夹名_text.txt |
| `pdf_to_line_numbered_text_说明.md` | 本说明文档 |

---

## 8. 若效果需微调

- **中线偏移**：若实际 PDF 左右栏不对称，可在脚本中将 `midline = pw / 2` 改为例如 `midline = pw * 0.45` 或 `pw * 0.55`，按实际版面调整。
- **双栏判定过严/过松**：目前「该页既有左又有右块」才标答/问；若希望某页强制按中线标，可在该页单独放宽双栏检测（需改代码）。
- **合并过猛/不足**：可调整 `merge_broken_sentences` 中的句末标点集合或「新句开头」模式（如增加/减少「问：」「答：」等前缀）。

以上逻辑均不依赖大模型，仅基于 A4 比例、页面宽度与文本块水平坐标。
